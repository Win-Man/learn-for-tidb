# 优化器概述

## SQL 优化器概念

SQL 优化器也称为查询优化器，是数据库的重要组成部分。一般数据库都由三部分组成：解析器、优化器、执行引擎。其中解析器负责将 SQL 语句解析成抽象语法树（AST），优化器对 AST 进行一系列优化之后生成执行计划，执行引擎负责根据优化器生成的执行计划去对应的存储引擎上执行操作获取符合 SQL 条件的数据。不同数据库之间的优化器大同小异，主要目的就是生成最高效的执行计划顺序以便执行引擎可以根据执行计划快速访问请求的数据。

## 查询优化器的分类

查询优化器一般分为两类：基于规则的优化器（Rule-Based Optimizer, RBO）和基于代价的优化器（Cost-Based Optimizer,CBO）。TiDB 中的查询优化器分为基于规则优化的逻辑优化部分以及基于代价优化的物理优化部分，

### 基于规则的优化

逻辑优化是基于规则的优化，对输入的逻辑执行计划按顺序应用一些优化规则，从而使整个逻辑执行计划变得更好。这些优化规则包括：

- 列裁剪
- 投影消除
- 关联子查询去关联
- Max/Min 消除
- 谓词下推
- 分区裁剪
- TopN 和 Limit 下推

### 基于代价的优化

逻辑执行计划是一个树形结构，每个节点对应 SQL 中的一个逻辑算子。同样的，物理执行计划也是一个树形结构，每个节点对应 SQL 中的一个物理算子。逻辑算子只描述这个算子的功能，而物理算子则描述了完成这个功能的具体算法。对于同一个逻辑算子，可能有多个物理算子实现，比如 LogicalAggregate，它的实现可以是采用哈希算法的 HashAggregate，也可以是流式的 StreamAggregate。不同的物理算子具有不同的物理属性，也对其子节点有着不同的物理属性的要求。物理属性包括数据的顺序和分布等。

## 优化器流程

![](https://raw.githubusercontent.com/Win-Man/pic-storage/master/img/023-1.png)

TiDB 一个查询语句的简单流程：一个语句经过 parser 后会得到一个抽象语法树（AST），首先用经过合法性检查后的 AST 生成一个逻辑计划，接着回去进行去关联化、谓词下推、聚合下推等规则化优化，然后通过统计信息数据计算代价，选择最优的物理执行计划。最后根据生成的最后的执行计划去存储引擎上请求数据。